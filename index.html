<!DOCTYPE html>
<html lang="en">
<meta name="version" content="v1.0">
<meta name="build-date" content="06/2023">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">

    <link rel="stylesheet" type="text/css" href="./static/css/normalize.css">

    <!-- bootstrap -->

    <!--suppress JSUnresolvedLibraryURL -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">


    <!--suppress JSUnresolvedLibraryURL -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <!--suppress JSUnresolvedLibraryURL -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">
    <!--suppress JSUnresolvedLibraryURL -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
    <!--suppress JSUnresolvedLibraryURL -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <!--suppress JSUnresolvedLibraryURL -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

    <!-- local -->

    <link rel="stylesheet" type="text/css" href="static/css/base.css">
    <link rel="stylesheet" type="text/css" href="static/css/aside.css">

    <!--    <script type="text/javascript" src="ad/functions/functions.js"></script>-->
    <script type="module" src="ad/algo.js"></script>
    <script type="module" src="ad/function-tree.js"></script>

    <!-- graphviz -->

    <script src="//d3js.org/d3.v5.min.js"></script>
    <!--suppress JSUnresolvedLibraryURL -->
    <script src="https://unpkg.com/@hpcc-js/wasm@0.3.11/dist/index.min.js"></script>
    <!--suppress JSUnresolvedLibraryURL -->
    <script src="https://unpkg.com/d3-graphviz@3.0.5/build/d3-graphviz.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/nearley@2.20.1/lib/nearley.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moo@0.5.2/moo.min.js"></script>
    <script type="module" src="parser/grammar.js"></script>
    <script type="module" src="parser/parser.js"></script>

    <!-- mathjax -->

    <script>
        MathJax = {
            autoload: {
                color: [],
                colorV2: ['color']
            },
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            },
            chtml: {
                displayAlign: 'left'
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <!--suppress JSUnresolvedLibraryURL -->
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

    <!-- loader -->

    <script type="text/javascript" >
        $(document).ready(() => {
            const version = $('meta[name="version"]').attr('content');
            const buildDate = $('meta[name="build-date"]').attr('content');

            $('html').append(`<i class="version">${version} \t ${buildDate}</i>`);
        });
    </script>

    <script type="module">
        import { BrowserManager } from "./ad/browser-manager.js";
        import { parseFunction } from "./parser/parser.js";

        export const browser = new BrowserManager.ExpressionManager(new BrowserManager.GraphManager("graph"), 3);

        console.log("Browser manager:", browser);
        console.log('parser', (input) => parseFunction(input));

        // fixme
        function notify(message) {
            alert(message);
        }

        // setup aside
        $(document).ready(function () {
            const elements = {
                'play': ['play-fill', () => browser.resume()],
                'step': ['file-play', () => browser.step()],
                'pause': ['pause', () => browser.pause()],
                'stop': ['stop-fill', () => browser.restart()],
            };

            const $aside = $('aside');

            for (const [name, [clazz, callback]] of Object.entries(elements)) {
                $aside.append(
`<div id="action-${name}" class="${name} btn btn-outline-primary">
    <span style="margin-right: 0.5rem">${name.charAt(0).toUpperCase() + name.slice(1)}</span>
    <i class="bi bi-${clazz}"></i>
</div>`
                );

                $aside.find(`#action-${name}`).click(callback);
            }

            // switch animation
            $aside.append(
`<div id="action-remove-animation" class="remove-animation btn btn-outline-primary" style="
    display: flex;
    align-items: center;
    justify-content: space-evenly;
    flex-direction: row;
">
    <div class="bi">Disable</br>animation</div>
    <i class="bi bi-film"></i>
</div>`
            );

            $aside.find('#action-remove-animation').click(function () {
                const now = browser.switchAnimation();

                $(this).find('span').text(now ? 'Disable</br>animation' : 'Enable</br>branimation');
            });
        });

        // setup variables-input
        $(document).ready(function () {
            let variables = 0;

            const $variables = $('.variables').find('.content');

            function newVar(name) {
                const $new = $($variables.find('template').prop('content')).clone();

                const $cell = $($new.find('template').prop('content'));

                const $tbody = $new.find('tbody');

                const getRowCount = () => $tbody.children().length;
                const getColCount = () => $tbody.children().first()?.children()?.length ?? 0;

                const newRow = () => {
                    if (getRowCount() >= 4) {
                        notify('Number of rows is not supported to be greater than 4')
                        return;
                    }

                    const $tr = $('<tr></tr>').appendTo($tbody);
                    $tbody.children().first().children().each(() => $tr.append($cell.clone()));
                };
                const newCol = () => {
                    if (getColCount() >= 4) {
                        notify('Number of columns is not supported to be greater than 4')
                        return;
                    }

                    $tbody.children().each((_, c) => $(c).append($cell.clone()))
                };

                // single cell
                newRow();
                newCol();

                $new.find('.expand-right').click(newCol);
                $new.find('.expand-down').click(newRow);

                $variables.append($new);

                const $appender = $('.new-var').clone(true);
                $('.new-var').remove();

                if ($variables.children().length < 5) {
                    $variables.append($appender);
                }
            }

            // noinspection JSJQueryEfficiency
            $('.new-var').click(() => newVar());
        });

        // LaTeX visualizer
        $(document).ready(() => $('#function-input').keyup(function () {
            const input = $("#function-input").val();

            // const expr = new FunctionTree.Div(new FunctionTree.Div(new FunctionTree.Variable("z"), new FunctionTree.Const(19)), new FunctionTree.Div(new FunctionTree.Div(new FunctionTree.Div(new FunctionTree.Tanh(new FunctionTree.Const(6)), new FunctionTree.Tanh(new FunctionTree.Tanh(new FunctionTree.Const(14)))), new FunctionTree.Const(87)), new FunctionTree.Add(new FunctionTree.Div(new FunctionTree.Tanh(new FunctionTree.Tanh(new FunctionTree.Const(25))), new FunctionTree.Tanh(new FunctionTree.Const(37))), new FunctionTree.Add(new FunctionTree.Tanh(new FunctionTree.Const(84)), new FunctionTree.Tanh(new FunctionTree.Variable("z"))))));
            // new FunctionTree.Add(new FunctionTree.Const(4), new FunctionTree.Variable("x"));

            const expr = parseFunction(input);

            const $functionError = $("#function-error");
            if (!expr.isOk()) {
                $functionError.text(expr.error());
                $functionError.show();
            } else {
                $functionError.hide();
            }

            const $function = $('#function-show');
            $function.text(expr.expr().map((e) => '\\[' + e.toTex() + '\\]').join(''));

            MathJax.typeset();

            const max = browser.setFunction(expr.graph);
            $('#player').attr('max', max)

            $('#graph').css('height', 'calc(' + $('main').css('max-height') + ' - ' + $function.height() + 'px - ' + $('#player').height() + 'px - 2rem)');
        }));

        // fps init
        $(document).ready(() => {
            // number of frames in one second
            const available = [0.2, 0.5, 1, 2, 3, 4, 5, 10];

            const $slider = $('#frametime');
            $slider.attr('min', 0);
            $slider.attr('max', available.length - 1);
            $slider.attr('step', 1);

            const $frametime = $('#frametime-show');
            const onupdate = () => {
                const v = available[$slider.val()];
                $frametime.text(v < 1 ? `1/${1 / v} fps` : `${v}/1 fps`);
                $frametime.attr('title', v < 1 ? `1 frames /${1 / v} sec` : `${v} frames / 1 ses`);

                browser.speedup(1 / v);
            };
            onupdate();
            $slider.change(onupdate);
            $slider.mousemove(onupdate);
        })

        // player init
        $(document).ready(function () {
            const $player = $('#player');
            $player.mousemove(() => browser.moveTo($player.val()));
        })
    </script>

    <link rel="icon" href="static/img/ad.ico">
    <title>AD Visualization</title>
</head>
<body>
<header>
    <img src="static/img/ad.ico" alt="ad.ico" class="icon">
    <h1>Automatic differentiation visualization</h1>
</header>
<aside>
    <div class="sep1"></div>
    <div class="fps">
        <label for="frametime" id="frametime-show" class="marker" style="text-align: center"></label>
        <input id="frametime" type="range" value="3"/>
    </div>
    <div class="sep2"></div>
    <div class="function">
        <label for="function-input" class="marker">Function</label>
        <textarea id="function-input" class="form-control" placeholder="f(x) = x^2 + 2x + ..."></textarea>
    </div>
    <div class="variables">
        <span class="marker">Variables</span>
        <div class="content">
            <template>
                <div class="var">
                    <label class="variable-name">
                        <input class="marker" type="text" placeholder="name"/>
                    </label>
                    <table class="input">
                        <template>
                            <th>
                                <label>
                                    <input class="table-item" type="number" step="0.01">
                                </label>
                            </th>
                        </template>
                        <tbody>
                        </tbody>
                    </table>
                    <div class="expand-right btn btn-outline-primary">
                        <span class="bi bi-caret-right-fill"></span>
                    </div>
                    <div class="expand-down btn btn-outline-primary">
                        <span class="bi bi-caret-down-fill"></span>
                    </div>
                </div>
            </template>
            <span class="new-var btn btn-outline-primary bi bi-plus-lg"></span>
        </div>
    </div>
</aside>
<main>
    <div class="function-show">
        <div id="function-show">No function is provided</div>
        <div id="function-error" style="color: red" hidden></div>
    </div>
    <label for="player" style="width: 100%;">
        <input id="player" type="range" style="width: 100%" min="0" max="1" step="1" value="0"/>
    </label>
    <div id="graph"></div>
</main>
<footer>
    &copy; Powered by <code>@AlexSin</code>
</footer>
</body>
</html>