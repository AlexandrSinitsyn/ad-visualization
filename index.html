<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <link rel="icon" href="ad.ico">
    <link rel="stylesheet" type="text/css" href="./static/css/normalize.css">
    <link rel="stylesheet" type="text/css" href="static/css/base.css">
    <link rel="stylesheet" type="text/css" href="static/css/ad-style.css">

    <!--suppress JSUnresolvedLibraryURL -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <!--suppress JSUnresolvedLibraryURL -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <!--    <script type="text/javascript" src="ad/functions/functions.js"></script>-->
    <script type="module" src="ad/algo.js"></script>
    <script type="module" src="ad/function-tree.js"></script>

    <script src="//d3js.org/d3.v5.min.js"></script>
    <!--suppress JSUnresolvedLibraryURL -->
    <script src="https://unpkg.com/@hpcc-js/wasm@0.3.11/dist/index.min.js"></script>
    <!--suppress JSUnresolvedLibraryURL -->
    <script src="https://unpkg.com/d3-graphviz@3.0.5/build/d3-graphviz.js"></script>

    <!--suppress JSUnresolvedLibraryURL -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>

    <script>
        MathJax = {
            autoload: {
                color: [],
                colorV2: ['color']
            },
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            },
            chtml: {
                displayAlign: 'left'
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <!--suppress JSUnresolvedLibraryURL -->
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

    <script type="module">
        import { FunctionTree } from "./ad/function-tree.js";
        import { BrowserManager } from "./ad/browser-manager.js";

        export const browser = new BrowserManager.ExpressionManager(new BrowserManager.GraphManager("graph"), 3);

        console.log("Browser manager:", browser);

        // control buttons
        $(document).ready(function () {
            const actionButtons = {
                'step': ['file-play', () => browser.step()],
                'resume': ['play-fill', () => browser.resume()],
                'pause': ['pause', () => browser.pause()],
                'stop': ['stop-fill', () => browser.restart()],
            };

            const $list = $(".actions > ul");

            for (const [name, [clazz, callback]] of Object.entries(actionButtons)) {
                const $item = $($list.find("template").prop("content")).clone().find("li");
                $item.attr("id", `${name}-button`);
                $item.click(callback);
                $item.find("span").text(name.charAt(0).toUpperCase() + name.slice(1));
                $item.find("i").attr("class", `bi bi-${clazz}`);
                $item.find("i").attr("id", `hello${name}`);

                $list.append($item);
            }
        });

        // setting buttons
        $(document).ready(function () {
            const settings = {
                'remove animation': browser.removeAnimation,
            };

            const $list = $($(".settings > ul"));

            for (const [name, callback] of Object.entries(settings)) {
                const $item = $($list.find("template").prop("content")).clone().find("li");
                $item.attr("class", "btn btn-outline-primary");
                $item.text(name);
                $item.click(callback);

                $list.append($item);
            }
        });

        // export const parser = new ExpressionParser();

        // LaTeX visualizer
        $(document).ready(() => $('#function-input').change(function () {
            const input = $("#function-input").text();

            const expr = new FunctionTree.Add(new FunctionTree.Const(4), new FunctionTree.Variable("x"));
            // const expr = parser.parse(input);

            // if (expr.errorFound()) {
            //     $("#function-error").text(expr.errorFound());
            //     return;
            // }

            $('#function-show').text('\\[' + expr.toTex() + '\\]');

            // const $iframe = $("#function-show").html('<iframe id="math-tex"></iframe>').find('#math-tex');
            // let contentDocument = $iframe[0].contentDocument;
            // contentDocument.open();
            // contentDocument.write('<main></main>');
            // contentDocument.close();
            //
            //     const $main = $iframe.contents().find('main');
            // $iframe.ready(() => $(function () {
            //     // hack to load lib into iframe
            //     // const res = $(this).append('<scr' + 'ipt id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></scr' + 'ipt>');
            //     // $(this).append('<div>asd</div>');
            //     //
            //     // console.log(res)
            //
            //     $main.append('<p id="formula"></p>')
            //
            //     $main.find("#formula").text('\\[' + expr.toTex() + '\\]');
            //
            //     $main.prepend($($("#mathjax-template").prop('content')).clone());
            // }));

            MathJax.typeset();

            browser.setFunction(expr);
        }));
    </script>

    <title>AD Visualization</title>
</head>
<body>
<header>
    <img src="ad.ico" alt="ad.ico">
    <h1>Automatic differentiation visualization</h1>
</header>
<main>
    <div id="function-show">No function is provided</div>
    <div id="function-error"></div>
    <div id="graph" style="text-align: center;"></div>
</main>
<aside>
    <div class="actions">
        <ul>
            <template>
                <li class="btn btn-outline-primary">
                    <span style="margin-right: 0.5rem"></span>
                    <i></i>
                </li>
            </template>
        </ul>
    </div>
    <div class="input">
        <label>
            <textarea id="function-input"></textarea>
        </label>
    </div>
    <i class="separator"></i>
    <div class="settings">
        <ul>
            <template>
                <li></li>
            </template>
        </ul>
    </div>
</aside>
<footer>
    &copy; AlexSin 2023
</footer>
</body>
</html>